!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="REPLACE_PATH_VARIABLE",i(i.s=0)}([function(t,e,i){"use strict";function s(){}function n(t){this.data=new t(1),this.data[0]=0}function r(){n.call(this,n.TYPE_8BIT)}function o(){n.call(this,n.TYPE_16BIT),this.bytes=new Uint8Array(this.data.buffer)}function c(t){this.data=new Uint8Array(t)}function a(){this.pc=new o,this.sp=new r,this.a=new r,this.x=new r,this.y=new r,this.p=new h,this.ram=new c(65536),this.ppu=null,this.apu=null,this.pad1=null,this.pad2=null,this.rom=null,this.stallCycle=0}function h(){r.call(this)}function S(){this.frame=0,this.scanLine=0,this.cycle=0,this.cpu=null,this.rom=null,this.display=null,this.vRam=new c(16384),this.oamRam=new c(256),this.oamRam2=new c(32),this.ppuctrl=new u,this.ppumask=new I,this.ppustatus=new d,this.oamaddr=new r,this.oamdata=new r,this.ppuscroll=new r,this.ppuaddr=new r,this.ppudata=new r,this.oamdma=new r,this.nameTableRegister=new r,this.attributeTableLowRegister=new o,this.attributeTableHighRegister=new o,this.patternTableLowRegister=new o,this.patternTableHighRegister=new o,this.nameTableLatch=0,this.attributeTableLowLatch=0,this.attributeTableHighLatch=0,this.patternTableLowLatch=0,this.patternTableHighLatch=0,this.fineXScroll=0,this.currentVRamAddress=0,this.temporalVRamAddress=0,this.vRamReadBuffer=0,this.registerFirstStore=!0,this.spritesManager=new l(this.oamRam),this.spritesManager2=new l(this.oamRam2),this.spritePixels=[],this.spriteIds=[],this.spritePriorities=[];for(var t=0;t<256;t++)this.spritePixels[t]=-1,this.spriteIds[t]=-1,this.spritePriorities[t]=-1}function u(){r.call(this)}function I(){r.call(this)}function d(){r.call(this)}function l(t){this.sprites=[],this.init(t)}function T(t,e,i){this.index=t,this.id=e,this.memory=i}function N(){this.cpu=null,this.audio=null,this.pulse1=new E(!0),this.pulse2=new E(!1),this.triangle=new p,this.noise=new m,this.dmc=new D(this),this.status=new A,this.frame=new C,this.cycle=0,this.step=0,this.samplePeriod=0,this.frameIrqActive=!1,this.dmcIrqActive=!1}function R(t){this.apu=t}function E(t){this.isChannel1=t,this.register0=new r,this.register1=new r,this.register2=new r,this.register3=new r,this.enabled=!1,this.timerCounter=0,this.timerPeriod=0,this.timerSequence=0,this.envelopeStartFlag=!0,this.envelopeCounter=0,this.envelopeDecayLevelCounter=0,this.lengthCounter=0,this.sweepReloadFlag=!1,this.sweepCycle=0,this.sweepCounter=0}function p(){this.register0=new r,this.register1=new r,this.register2=new r,this.register3=new r,this.enabled=!1,this.timerCounter=0,this.timerSequence=0,this.lengthCounter=0,this.linearReloadFlag=!1,this.linearCounter=0}function m(){this.register0=new r,this.register1=new r,this.register2=new r,this.register3=new r,this.enabled=!1,this.timerCounter=0,this.timerPeriod=0,this.envelopeStartFlag=!1,this.envelopeCounter=0,this.envelopeDecayLevelCounter=0,this.lengthCounter=0,this.shiftRegister=1}function D(t){this.apu=t,this.register0=new r,this.register1=new r,this.register2=new r,this.register3=new r,this.enabled=!1,this.timerPeriod=0,this.timerCounter=0,this.deltaCounter=0,this.addressCounter=0,this.remainingBytesCounter=0,this.sampleBuffer=0,this.sampleBufferIsEmpty=!0,this.shiftRegister=0,this.remainingBitsCounter=0,this.silenceFlag=!0}function A(){r.call(this)}function C(){r.call(this)}function g(){this.register=new r,this.latch=0,this.currentButton=0,this.buttonNum=this.getButtonsNum(),this.buttons=[];for(var t=0;t<this.buttonNum;t++)this.buttons[t]=!1}function O(){this.ppu=new S,this.cpu=new a,this.apu=new N,this.pad1=new g,this.pad2=new g,this.rom=null,this.cpu.setPpu(this.ppu),this.cpu.setApu(this.apu),this.cpu.setJoypad1(this.pad1),this.cpu.setJoypad2(this.pad2),this.ppu.setCpu(this.cpu),this.apu.setCpu(this.cpu),this.state=this.STATES.POWER_OFF,this.audioEnabled=!1;var t=this;this.runFunc=function(){t.run()},this.onFpsUpdates=[]}var y,B;function f(){}function _(t){this.rom=t,this.prgBankNum=t.header.getPRGROMBanksNum(),this.chrBankNum=t.header.getCHRROMBanksNum()}function U(t){_.call(this,t)}function L(t){_.call(this,t),this.controlRegister=new r,this.chrBank0Register=new r,this.chrBank1Register=new r,this.prgBankRegister=new r,this.latch=new r,this.registerWriteCount=0,this.controlRegister.store(12)}function b(t){_.call(this,t),this.reg=new r}function P(t){_.call(this,t),this.reg=new r}function v(t){_.call(this,t),this.addrReg=new r,this.chrReg0=new r,this.chrReg1=new r,this.chrReg2=new r,this.chrReg3=new r,this.prgReg0=new r,this.prgReg1=new r}function M(t){if(c.call(this,t),this.header=new G(this),!1===this.isNes())throw new Error("This rom doesn't seem iNES format.");this.mapperFactory=new f,this.mapper=this.mapperFactory.create(this.header.getMapperNum(),this)}function G(t){this.rom=t}function k(){var t=this,e=AudioContext||webkitAudioContext;if(void 0===e)throw new Error("This browser seems not to support AudioContext.");this.bufferLength=4096,this.buffer=new Float32Array(this.bufferLength),this.bufferIndex=0,this.context=new e,this.scriptProcessor=this.context.createScriptProcessor(this.bufferLength,0,1),this.scriptProcessor.onaudioprocess=function(e){t.onAudioProcess(e)},this.scriptProcessor.connect(this.context.destination),this.sampleRate=this.context.sampleRate}function V(t){this.ctx=t.getContext("2d"),this.width=t.width=256,this.height=t.height=240,this.data=this.ctx.createImageData(this.width,this.height),this.uint32=new Uint32Array(this.data.data.buffer)}function w(){}let X;i.r(e),s.convertDecToHexString=function(t,e,i){var s=t.toString(16),n="";if(t<0&&(n+="-"),!0!==i&&(n+="0x"),void 0===e)return n+s;for(var r="",o=0;o<e;o++)r+="0";return n+(r+s).substr(-1*e)},n.TYPE_8BIT=Uint8Array,n.TYPE_16BIT=Uint16Array,Object.assign(n.prototype,{isRegister:!0,getWidth:function(){return 8*this.data.byteLength},load:function(){return this.data[0]},loadBit:function(t){return this.data[0]>>t&1},loadBits:function(t,e){return this.data[0]>>t&(1<<e)-1},store:function(t){this.data[0]=t},storeBit:function(t,e){e&=1,this.data[0]=this.data[0]&~(1<<t)|e<<t},storeBits:function(t,e,i){var s=(1<<e)-1;i&=s,this.data[0]=this.data[0]&~(s<<t)|i<<t},clear:function(){this.data[0]=0},setBit:function(t){this.storeBit(t,1)},clearBit:function(t){this.storeBit(t,0)},isBitSet:function(t){return 1===this.loadBit(t)},increment:function(){this.data[0]++},incrementBy2:function(){this.data[0]+=2},add:function(t){this.data[0]+=t},decrement:function(){this.data[0]--},decrementBy2:function(){this.data[0]-=2},sub:function(t){this.data[0]-=t},shift:function(t){t&=1;var e=this.loadBit(this.getWidth()-1);return this.data[0]=this.data[0]<<1|t,e},dump:function(){return s.convertDecToHexString(this.load(),this.getWidth()/4)}}),r.prototype=Object.assign(Object.create(n.prototype),{isRegister8bit:!0}),o.prototype=Object.assign(Object.create(n.prototype),{isRegister16bit:!0,loadHigherByte:function(){return this.bytes[1]},loadLowerByte:function(){return this.bytes[0]},storeHigherByte:function(t){this.bytes[1]=t},storeLowerByte:function(t){this.bytes[0]=t}}),Object.assign(c.prototype,{isMemory:!0,clear:function(){for(var t=0,e=this.getCapacity();t<e;t++)this.storeWithoutMapping(t,0)},getCapacity:function(){return this.data.byteLength},load:function(t){return this.data[t]},loadWithoutMapping:function(t){return this.data[t]},store:function(t,e){this.data[t]=e},storeWithoutMapping:function(t,e){this.data[t]=e},dump:function(){for(var t="",e=!1,i=this._getStartDumpAddress(),n=this._getEndDumpAddress(),r=i;r<n;r++){if(r%16==0){if(e){for(var o=!1;this._checkNext16BytesIsZero(r+16);)r+=16,o=!0;o&&(t+="...\n")}t+=s.convertDecToHexString(r-i,4)+" ",e=!0}var c=this._loadForDump(r);t+=s.convertDecToHexString(c,2,!0)+" ",0!=c&&(e=!1),r%16==15&&(t+="\n")}return t},_loadForDump:function(t){return this.loadWithoutMapping(t)},_getStartDumpAddress:function(){return 0},_getEndDumpAddress:function(){return this.getCapacity()},_checkNext16BytesIsZero:function(t){if(t+16>=this._getEndDumpAddress())return!1;for(var e=0,i=t;i<t+16;i++)e+=this._loadForDump(i);return 0===e}}),a.INTERRUPTS={NMI:0,RESET:1,IRQ:2,BRK:3},a.INTERRUPT_HANDLER_ADDRESSES=[],a.INTERRUPT_HANDLER_ADDRESSES[a.INTERRUPTS.NMI]=65530,a.INTERRUPT_HANDLER_ADDRESSES[a.INTERRUPTS.RESET]=65532,a.INTERRUPT_HANDLER_ADDRESSES[a.INTERRUPTS.IRQ]=65534,a.INTERRUPT_HANDLER_ADDRESSES[a.INTERRUPTS.BRK]=65534,a.INSTRUCTIONS={INV:{id:0,name:"inv"},ADC:{id:1,name:"adc"},AND:{id:2,name:"and"},ASL:{id:3,name:"asl"},BCC:{id:4,name:"bcc"},BCS:{id:5,name:"bcs"},BEQ:{id:6,name:"beq"},BIT:{id:7,name:"bit"},BMI:{id:8,name:"bmi"},BNE:{id:9,name:"bne"},BPL:{id:10,name:"bpl"},BRK:{id:11,name:"brk"},BVC:{id:12,name:"bvc"},BVS:{id:13,name:"bvs"},CLC:{id:14,name:"clc"},CLD:{id:15,name:"cld"},CLI:{id:16,name:"cli"},CLV:{id:17,name:"clv"},CMP:{id:18,name:"cmp"},CPX:{id:19,name:"cpx"},CPY:{id:20,name:"cpy"},DEC:{id:21,name:"dec"},DEX:{id:22,name:"dex"},DEY:{id:23,name:"dey"},EOR:{id:24,name:"eor"},INC:{id:25,name:"inc"},INX:{id:26,name:"inx"},INY:{id:27,name:"iny"},JMP:{id:28,name:"jmp"},JSR:{id:29,name:"jsr"},LDA:{id:30,name:"lda"},LDX:{id:31,name:"ldx"},LDY:{id:32,name:"ldy"},LSR:{id:33,name:"lsr"},NOP:{id:34,name:"nop"},ORA:{id:35,name:"ora"},PHA:{id:36,name:"pha"},PHP:{id:37,name:"php"},PLA:{id:38,name:"pla"},PLP:{id:39,name:"plp"},ROL:{id:40,name:"rol"},ROR:{id:41,name:"ror"},RTI:{id:42,name:"rti"},RTS:{id:43,name:"rts"},SBC:{id:44,name:"sbc"},SEC:{id:45,name:"sec"},SED:{id:46,name:"sed"},SEI:{id:47,name:"sei"},STA:{id:48,name:"sta"},STX:{id:49,name:"stx"},STY:{id:50,name:"sty"},TAX:{id:51,name:"tax"},TAY:{id:52,name:"tay"},TSX:{id:53,name:"tsx"},TXA:{id:54,name:"txa"},TXS:{id:55,name:"txs"},TYA:{id:56,name:"tya"}},a.ADDRESSINGS={IMMEDIATE:{id:0,pc:2,name:"immediate"},ABSOLUTE:{id:1,pc:3,name:"absolute"},INDEXED_ABSOLUTE_X:{id:2,pc:3,name:"indexed_absolute_x"},INDEXED_ABSOLUTE_Y:{id:3,pc:3,name:"indexed_absolute_y"},ZERO_PAGE:{id:4,pc:2,name:"zero_page"},INDEXED_ZERO_PAGE_X:{id:5,pc:2,name:"indexed_zero_page_x"},INDEXED_ZERO_PAGE_Y:{id:6,pc:2,name:"indexed_zero_page_y"},IMPLIED:{id:7,pc:1,name:"implied"},ACCUMULATOR:{id:8,pc:1,name:"accumulator"},INDIRECT:{id:9,pc:3,name:"indirect"},INDEXED_INDIRECT_X:{id:10,pc:2,name:"indexed_indirect_x"},INDEXED_INDIRECT_Y:{id:11,pc:2,name:"indexed_indirect_y"},RELATIVE:{id:12,pc:2,name:"relative"}},a.OPS=[{instruction:a.INSTRUCTIONS.BRK,cycle:7,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.ORA,cycle:6,mode:a.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.ORA,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.ASL,cycle:5,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.PHP,cycle:3,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.ORA,cycle:2,mode:a.ADDRESSINGS.IMMEDIATE},{instruction:a.INSTRUCTIONS.ASL,cycle:2,mode:a.ADDRESSINGS.ACCUMULATOR},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.ORA,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.ASL,cycle:6,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.BPL,cycle:2,mode:a.ADDRESSINGS.RELATIVE},{instruction:a.INSTRUCTIONS.ORA,cycle:5,mode:a.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.ORA,cycle:4,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.ASL,cycle:6,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.CLC,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.ORA,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.ORA,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.ASL,cycle:7,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.JSR,cycle:0,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.AND,cycle:6,mode:a.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.BIT,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.AND,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.ROL,cycle:5,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.PLP,cycle:4,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.AND,cycle:2,mode:a.ADDRESSINGS.IMMEDIATE},{instruction:a.INSTRUCTIONS.ROL,cycle:2,mode:a.ADDRESSINGS.ACCUMULATOR},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.BIT,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.AND,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.ROL,cycle:6,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.BMI,cycle:2,mode:a.ADDRESSINGS.RELATIVE},{instruction:a.INSTRUCTIONS.AND,cycle:5,mode:a.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.AND,cycle:4,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.ROL,cycle:6,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.SEC,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.AND,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.AND,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.ROL,cycle:7,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.RTI,cycle:6,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.EOR,cycle:6,mode:a.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.EOR,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.LSR,cycle:5,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.PHA,cycle:3,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.EOR,cycle:2,mode:a.ADDRESSINGS.IMMEDIATE},{instruction:a.INSTRUCTIONS.LSR,cycle:2,mode:a.ADDRESSINGS.ACCUMULATOR},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.JMP,cycle:0,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.EOR,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.LSR,cycle:6,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.BVC,cycle:2,mode:a.ADDRESSINGS.RELATIVE},{instruction:a.INSTRUCTIONS.EOR,cycle:5,mode:a.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.EOR,cycle:4,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.LSR,cycle:6,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.CLI,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.EOR,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.EOR,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.LSR,cycle:7,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.RTS,cycle:6,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.ADC,cycle:6,mode:a.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.ADC,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.ROR,cycle:5,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.PLA,cycle:4,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.ADC,cycle:2,mode:a.ADDRESSINGS.IMMEDIATE},{instruction:a.INSTRUCTIONS.ROR,cycle:2,mode:a.ADDRESSINGS.ACCUMULATOR},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.JMP,cycle:0,mode:a.ADDRESSINGS.INDIRECT},{instruction:a.INSTRUCTIONS.ADC,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.ROR,cycle:6,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.BVS,cycle:2,mode:a.ADDRESSINGS.RELATIVE},{instruction:a.INSTRUCTIONS.ADC,cycle:5,mode:a.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.ADC,cycle:4,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.ROR,cycle:6,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.SEI,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.ADC,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.ADC,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.ROR,cycle:7,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.STA,cycle:6,mode:a.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.STY,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.STA,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.STX,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.DEY,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.TXA,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.STY,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.STA,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.STX,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.BCC,cycle:2,mode:a.ADDRESSINGS.RELATIVE},{instruction:a.INSTRUCTIONS.STA,cycle:6,mode:a.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.STY,cycle:4,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.STA,cycle:4,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.STX,cycle:4,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.TYA,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.STA,cycle:5,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:a.INSTRUCTIONS.TXS,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.STA,cycle:5,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.LDY,cycle:2,mode:a.ADDRESSINGS.IMMEDIATE},{instruction:a.INSTRUCTIONS.LDA,cycle:6,mode:a.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:a.INSTRUCTIONS.LDX,cycle:2,mode:a.ADDRESSINGS.IMMEDIATE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.LDY,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.LDA,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.LDX,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.TAY,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.LDA,cycle:2,mode:a.ADDRESSINGS.IMMEDIATE},{instruction:a.INSTRUCTIONS.TAX,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.LDY,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.LDA,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.LDX,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.BCS,cycle:2,mode:a.ADDRESSINGS.RELATIVE},{instruction:a.INSTRUCTIONS.LDA,cycle:5,mode:a.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.LDY,cycle:4,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.LDA,cycle:4,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.LDX,cycle:4,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.CLV,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.LDA,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:a.INSTRUCTIONS.TSX,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.LDY,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.LDA,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.LDX,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.CPY,cycle:2,mode:a.ADDRESSINGS.IMMEDIATE},{instruction:a.INSTRUCTIONS.CMP,cycle:6,mode:a.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.CPY,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.CMP,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.DEC,cycle:5,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INY,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.CMP,cycle:2,mode:a.ADDRESSINGS.IMMEDIATE},{instruction:a.INSTRUCTIONS.DEX,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.CPY,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.CMP,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.DEC,cycle:6,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.BNE,cycle:2,mode:a.ADDRESSINGS.RELATIVE},{instruction:a.INSTRUCTIONS.CMP,cycle:5,mode:a.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.CMP,cycle:4,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.DEC,cycle:6,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.CLD,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.CMP,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.CMP,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.DEC,cycle:7,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.CPX,cycle:2,mode:a.ADDRESSINGS.IMMEDIATE},{instruction:a.INSTRUCTIONS.SBC,cycle:6,mode:a.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.CPX,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.SBC,cycle:3,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.INC,cycle:5,mode:a.ADDRESSINGS.ZERO_PAGE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INX,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.SBC,cycle:2,mode:a.ADDRESSINGS.IMMEDIATE},{instruction:a.INSTRUCTIONS.NOP,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.CPX,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.SBC,cycle:4,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.INC,cycle:6,mode:a.ADDRESSINGS.ABSOLUTE},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.BEQ,cycle:2,mode:a.ADDRESSINGS.RELATIVE},{instruction:a.INSTRUCTIONS.SBC,cycle:5,mode:a.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.SBC,cycle:4,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.INC,cycle:6,mode:a.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.SED,cycle:2,mode:a.ADDRESSINGS.IMPLIED},{instruction:a.INSTRUCTIONS.SBC,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:a.INSTRUCTIONS.SBC,cycle:4,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.INC,cycle:7,mode:a.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:a.INSTRUCTIONS.INV,cycle:0,mode:null}],Object.assign(a.prototype,{isCpu:!0,INTERRUPTS:a.INTERRUPTS,INTERRUPT_HANDLER_ADDRESSES:a.INTERRUPT_HANDLER_ADDRESSES,ADDRESSINGS:a.ADDRESSINGS,INSTRUCTIONS:a.INSTRUCTIONS,OPS:a.OPS,setPpu:function(t){this.ppu=t},setApu:function(t){this.apu=t},setJoypad1:function(t){this.pad1=t},setJoypad2:function(t){this.pad2=t},setRom:function(t){this.rom=t},bootup:function(){this.p.store(52),this.a.clear(),this.x.clear(),this.y.clear(),this.sp.store(253);for(var t=0;t<15;t++)this.store(16384+t,0);this.store(16405,0),this.store(16407,0),this.interrupt(this.INTERRUPTS.RESET)},reset:function(){this.sp.sub(3),this.p.setI(),this.interrupt(this.INTERRUPTS.RESET)},runCycle:function(){if(!0!==this.isStall()){var t=this.fetch(),e=this.decode(t);this.operate(e,t),this.stallCycle=e.cycle}this.stallCycle--},isStall:function(){return this.stallCycle>0},interrupt:function(t){t===this.INTERRUPTS.IRQ&&!0===this.p.isI()||(t!==this.INTERRUPTS.RESET&&(t!==this.INTERRUPTS.BRK&&this.p.clearB(),this.p.setA(),this.pushStack2Bytes(this.pc.load()),this.pushStack(this.p.load()),this.p.setI()),this.jumpToInterruptHandler(t))},load:function(t){return(t&=65535)>=0&&t<8192?this.ram.load(2047&t):t>=8192&&t<16384?this.ppu.loadRegister(8199&t):t>=16384&&t<16404?this.apu.loadRegister(t):16404===t?this.ppu.loadRegister(t):16405===t?this.apu.loadRegister(t):16406===t?this.pad1.loadRegister():t>=16407&&t<16416?this.apu.loadRegister(t):t>=16416&&t<24576||t>=24576&&t<32768?this.ram.load(t):t>=32768&&t<65536?this.rom.load(t):void 0},store:function(t,e){return(t&=65535)>=0&&t<8192?this.ram.store(2047&t,e):t>=8192&&t<16384?this.ppu.storeRegister(8199&t,e):t>=16384&&t<16404?this.apu.storeRegister(t,e):16404===t?this.ppu.storeRegister(t,e):16405===t?this.apu.storeRegister(t,e):16406===t?this.pad1.storeRegister(e):t>=16407&&t<16416?this.apu.storeRegister(t,e):t>=16416&&t<24576||t>=24576&&t<32768?this.ram.store(t,e):t>=32768&&t<65536?this.rom.store(t,e):void 0},load2Bytes:function(t){return this.load(t)|this.load(t+1)<<8},load2BytesFromZeropage:function(t){return this.ram.load(255&t)|this.ram.load(t+1&255)<<8},load2BytesInPage:function(t){var e=t,i=65280&t|t+1&255;return this.load(e)|this.load(i)<<8},store2Bytes:function(t,e){this.store(t,e),this.store(t+1,e>>8)},fetch:function(){var t=this.load(this.pc.load());return this.pc.increment(),t},decode:function(t){return this.OPS[t]},jumpToInterruptHandler:function(t){this.pc.store(this.load2Bytes(this.INTERRUPT_HANDLER_ADDRESSES[t]))},loadWithAddressingMode:function(t){if(t.mode.id===this.ADDRESSINGS.ACCUMULATOR.id)return this.a.load();var e=this.getAddressWithAddressingMode(t),i=this.load(e);return t.mode.id===this.ADDRESSINGS.RELATIVE.id&&128&i&&(i|=65280),i},storeWithAddressingMode:function(t,e){if(t.mode.id!==this.ADDRESSINGS.ACCUMULATOR.id){var i=this.getAddressWithAddressingMode(t);this.store(i,e)}else this.a.store(e)},updateMemoryWithAddressingMode:function(t,e){var i,s;t.mode.id==this.ADDRESSINGS.ACCUMULATOR.id?s=this.a.load():(i=this.getAddressWithAddressingMode(t),s=this.load(i));var n=e(s);t.mode.id==this.ADDRESSINGS.ACCUMULATOR.id?this.a.store(n):this.store(i,n)},getAddressWithAddressingMode:function(t){var e=null;switch(t.mode.id){case this.ADDRESSINGS.IMMEDIATE.id:case this.ADDRESSINGS.RELATIVE.id:e=this.pc.load(),this.pc.increment();break;case this.ADDRESSINGS.ABSOLUTE.id:case this.ADDRESSINGS.INDEXED_ABSOLUTE_X.id:case this.ADDRESSINGS.INDEXED_ABSOLUTE_Y.id:switch(e=this.load2Bytes(this.pc.load()),this.pc.incrementBy2(),t.mode.id){case this.ADDRESSINGS.INDEXED_ABSOLUTE_X.id:e+=this.x.load();break;case this.ADDRESSINGS.INDEXED_ABSOLUTE_Y.id:e+=this.y.load()}e&=65535;break;case this.ADDRESSINGS.ZERO_PAGE.id:case this.ADDRESSINGS.INDEXED_ZERO_PAGE_X.id:case this.ADDRESSINGS.INDEXED_ZERO_PAGE_Y.id:switch(e=this.load(this.pc.load()),this.pc.increment(),t.mode.id){case this.ADDRESSINGS.INDEXED_ZERO_PAGE_X.id:e+=this.x.load();break;case this.ADDRESSINGS.INDEXED_ZERO_PAGE_Y.id:e+=this.y.load()}e&=255;break;case this.ADDRESSINGS.INDIRECT.id:var i=this.load2Bytes(this.pc.load());this.pc.incrementBy2(),e=this.load2BytesInPage(i);break;case this.ADDRESSINGS.INDEXED_INDIRECT_X.id:i=this.load(this.pc.load());this.pc.increment(),i+=this.x.load(),i&=255,e=this.load2BytesFromZeropage(i);break;case this.ADDRESSINGS.INDEXED_INDIRECT_Y.id:i=this.load(this.pc.load());this.pc.increment(),e=this.load2BytesFromZeropage(i),e+=this.y.load(),e&=65535;break;default:throw new Error("Cpu: Unkown addressing mode.")}return e},updateN:function(t){0==(128&t)?this.p.clearN():this.p.setN()},updateZ:function(t){0==(255&t)?this.p.setZ():this.p.clearZ()},updateC:function(t){0==(256&t)?this.p.clearC():this.p.setC()},getStackAddress:function(){return this.sp.load()+256},pushStack:function(t){this.store(this.getStackAddress(),t),this.sp.decrement()},pushStack2Bytes:function(t){this.store(this.getStackAddress(),t>>8&255),this.sp.decrement(),this.store(this.getStackAddress(),255&t),this.sp.decrement()},popStack:function(){return this.sp.increment(),this.load(this.getStackAddress())},popStack2Bytes:function(){this.sp.increment();var t=this.load(this.getStackAddress());return this.sp.increment(),this.load(this.getStackAddress())<<8|t},doBranch:function(t,e){var i=this.loadWithAddressingMode(t);e&&this.pc.add(i)},operate:function(t,e){switch(t.instruction.id){case this.INSTRUCTIONS.ADC.id:var i=(c=this.a.load())+(a=this.loadWithAddressingMode(t))+(h=this.p.isC()?1:0);this.a.store(i),this.updateN(i),this.updateZ(i),this.updateC(i),!(128&(c^a))&&128&(a^i)?this.p.setV():this.p.clearV();break;case this.INSTRUCTIONS.AND.id:i=(c=this.a.load())&(a=this.loadWithAddressingMode(t));this.a.store(i),this.updateN(i),this.updateZ(i);break;case this.INSTRUCTIONS.ASL.id:var n=this,r=function(t){var e=t<<1;return n.updateN(e),n.updateZ(e),n.updateC(e),e};this.updateMemoryWithAddressingMode(t,r);break;case this.INSTRUCTIONS.BCC.id:this.doBranch(t,!this.p.isC());break;case this.INSTRUCTIONS.BCS.id:this.doBranch(t,this.p.isC());break;case this.INSTRUCTIONS.BEQ.id:this.doBranch(t,this.p.isZ());break;case this.INSTRUCTIONS.BIT.id:i=(c=this.a.load())&(a=this.loadWithAddressingMode(t));this.updateN(a),this.updateZ(i),0==(64&a)?this.p.clearV():this.p.setV();break;case this.INSTRUCTIONS.BMI.id:this.doBranch(t,this.p.isN());break;case this.INSTRUCTIONS.BNE.id:this.doBranch(t,!this.p.isZ());break;case this.INSTRUCTIONS.BPL.id:this.doBranch(t,!this.p.isN());break;case this.INSTRUCTIONS.BRK.id:this.pc.increment(),this.p.setA(),this.p.setB(),this.interrupt(this.INTERRUPTS.BRK);break;case this.INSTRUCTIONS.BVC.id:this.doBranch(t,!this.p.isV());break;case this.INSTRUCTIONS.BVS.id:this.doBranch(t,this.p.isV());break;case this.INSTRUCTIONS.CLC.id:this.p.clearC();break;case this.INSTRUCTIONS.CLD.id:this.p.clearD();break;case this.INSTRUCTIONS.CLI.id:this.p.clearI();break;case this.INSTRUCTIONS.CLV.id:this.p.clearV();break;case this.INSTRUCTIONS.CMP.id:case this.INSTRUCTIONS.CPX.id:case this.INSTRUCTIONS.CPY.id:switch(t.instruction.id){case this.INSTRUCTIONS.CMP.id:c=this.a.load();break;case this.INSTRUCTIONS.CPX.id:c=this.x.load();break;case this.INSTRUCTIONS.CPY.id:c=this.y.load()}i=c-(a=this.loadWithAddressingMode(t));this.updateN(i),this.updateZ(i),c>=a?this.p.setC():this.p.clearC();break;case this.INSTRUCTIONS.DEC.id:n=this,r=function(t){var e=t-1;return n.updateN(e),n.updateZ(e),e};this.updateMemoryWithAddressingMode(t,r);break;case this.INSTRUCTIONS.DEX.id:case this.INSTRUCTIONS.DEY.id:switch(t.instruction.id){case this.INSTRUCTIONS.DEX.id:S=this.x;break;case this.INSTRUCTIONS.DEY.id:S=this.y}i=(c=S.load())-1;S.store(i),this.updateN(i),this.updateZ(i);break;case this.INSTRUCTIONS.EOR.id:i=(c=this.a.load())^(a=this.loadWithAddressingMode(t));this.a.store(i),this.updateN(i),this.updateZ(i);break;case this.INSTRUCTIONS.INC.id:n=this,r=function(t){var e=t+1;return n.updateN(e),n.updateZ(e),e};this.updateMemoryWithAddressingMode(t,r);break;case this.INSTRUCTIONS.INX.id:case this.INSTRUCTIONS.INY.id:switch(t.instruction.id){case this.INSTRUCTIONS.INX.id:S=this.x;break;case this.INSTRUCTIONS.INY.id:S=this.y}i=(c=S.load())+1;S.store(i),this.updateN(i),this.updateZ(i);break;case this.INSTRUCTIONS.JMP.id:var o=this.getAddressWithAddressingMode(t);this.pc.store(o);break;case this.INSTRUCTIONS.JSR.id:o=this.getAddressWithAddressingMode(t);this.pc.decrement(),this.pushStack2Bytes(this.pc.load()),this.pc.store(o);break;case this.INSTRUCTIONS.LDA.id:case this.INSTRUCTIONS.LDX.id:case this.INSTRUCTIONS.LDY.id:i=this.loadWithAddressingMode(t);switch(t.instruction.id){case this.INSTRUCTIONS.LDA.id:S=this.a;break;case this.INSTRUCTIONS.LDX.id:S=this.x;break;case this.INSTRUCTIONS.LDY.id:S=this.y}S.store(i),this.updateN(i),this.updateZ(i);break;case this.INSTRUCTIONS.LSR.id:n=this,r=function(t){var e=t>>1;return n.p.clearN(),n.updateZ(e),0==(1&t)?n.p.clearC():n.p.setC(),e};this.updateMemoryWithAddressingMode(t,r);break;case this.INSTRUCTIONS.NOP.id:break;case this.INSTRUCTIONS.ORA.id:i=(c=this.a.load())|(a=this.loadWithAddressingMode(t));this.a.store(i),this.updateN(i),this.updateZ(i);break;case this.INSTRUCTIONS.PHA.id:case this.INSTRUCTIONS.PHP.id:switch(t.instruction.id){case this.INSTRUCTIONS.PHA.id:S=this.a;break;case this.INSTRUCTIONS.PHP.id:this.p.setA(),this.p.setB(),S=this.p}this.pushStack(S.load());break;case this.INSTRUCTIONS.PLA.id:i=this.popStack();this.a.store(i),this.updateN(i),this.updateZ(i);break;case this.INSTRUCTIONS.PLP.id:this.p.store(this.popStack());break;case this.INSTRUCTIONS.ROL.id:n=this,r=function(t){var e=t<<1|(n.p.isC()?1:0);return n.updateN(e),n.updateZ(e),n.updateC(e),e};this.updateMemoryWithAddressingMode(t,r);break;case this.INSTRUCTIONS.ROR.id:n=this,r=function(t){var e=t>>1|(n.p.isC()?128:0);return n.updateN(e),n.updateZ(e),0==(1&t)?n.p.clearC():n.p.setC(),e};this.updateMemoryWithAddressingMode(t,r);break;case this.INSTRUCTIONS.RTI.id:this.p.store(this.popStack()),this.pc.store(this.popStack2Bytes());break;case this.INSTRUCTIONS.RTS.id:this.pc.store(this.popStack2Bytes()+1);break;case this.INSTRUCTIONS.SBC.id:var c,a,h;i=(c=this.a.load())-(a=this.loadWithAddressingMode(t))-(h=this.p.isC()?0:1);this.a.store(i),this.updateN(i),this.updateZ(i),c>=a+h?this.p.setC():this.p.clearC(),128&(c^i)&&128&(c^a)?this.p.setV():this.p.clearV();break;case this.INSTRUCTIONS.SEC.id:this.p.setC();break;case this.INSTRUCTIONS.SED.id:this.p.setD();break;case this.INSTRUCTIONS.SEI.id:this.p.setI();break;case this.INSTRUCTIONS.STA.id:case this.INSTRUCTIONS.STX.id:case this.INSTRUCTIONS.STY.id:var S;switch(t.instruction.id){case this.INSTRUCTIONS.STA.id:S=this.a;break;case this.INSTRUCTIONS.STX.id:S=this.x;break;case this.INSTRUCTIONS.STY.id:S=this.y}this.storeWithAddressingMode(t,S.load());break;case this.INSTRUCTIONS.TAX.id:case this.INSTRUCTIONS.TAY.id:case this.INSTRUCTIONS.TSX.id:case this.INSTRUCTIONS.TXA.id:case this.INSTRUCTIONS.TXS.id:case this.INSTRUCTIONS.TYA.id:var u,I;switch(t.instruction.id){case this.INSTRUCTIONS.TAX.id:u=this.a,I=this.x;break;case this.INSTRUCTIONS.TAY.id:u=this.a,I=this.y;break;case this.INSTRUCTIONS.TSX.id:u=this.sp,I=this.x;break;case this.INSTRUCTIONS.TXA.id:u=this.x,I=this.a;break;case this.INSTRUCTIONS.TXS.id:u=this.x,I=this.sp;break;case this.INSTRUCTIONS.TYA.id:u=this.y,I=this.a}i=u.load();I.store(i),t.instruction.id!=this.INSTRUCTIONS.TXS.id&&(this.updateN(i),this.updateZ(i));break;default:throw new Error("Cpu.operate: Invalid instruction, pc="+s.convertDecToHexString(this.pc.load()-1)+" opc="+s.convertDecToHexString(e,2)+" name="+t.instruction.name)}},disassembleROM:function(){for(var t="",e=this.rom,i=e.getHeaderSize(),n=!1,r=!1;i<16400;){var o="",c=e.loadWithoutMapping(i),a=this.decode(c);if(n&&0==c&&0==e.loadWithoutMapping(i+1&65535))i+=1,r=!0;else{for(r&&(t+="...\n"),r=!1,o+=s.convertDecToHexString(i-e.getHeaderSize(),4)+" ",o+=s.convertDecToHexString(c,2)+" ",o+=a.instruction.name+" ",o+=this.dumpMemoryAddressingMode(a,e,i+1&65535)+" ";o.length<30;)o+=" ";a.mode?(o+=a.mode.name,i+=a.mode.pc):i+=1,t+=o+"\n",n=0==c}}return t},dump:function(){var t="",e=this.load(this.pc.load()),i=this.decode(e);for(t+="p:"+this.p.dump()+" ",t+="pc:"+this.pc.dump()+"("+s.convertDecToHexString(e,2)+") ",t+="sp:"+this.sp.dump()+" ",t+="a:"+this.a.dump()+" ",t+="x:"+this.x.dump()+" ",t+="y:"+this.y.dump()+" ",t+=i.instruction.name+" "+this.dumpMemoryAddressingMode(i,this,this.pc.load()+1&65535)+" ";t.length<90;)t+=" ";return t+=i.mode.name},dumpRAM:function(){return this.ram.dump()},dumpMemoryAddressingMode:function(t,e,i){var n="",r=e instanceof a;switch(t.mode){case this.ADDRESSINGS.IMMEDIATE:n+="#"+s.convertDecToHexString(e.load(i,!0),2);break;case this.ADDRESSINGS.RELATIVE:var o=e.load(i,!0);128&o&&(o=-(256-o)),n+=o.toString(10);break;case this.ADDRESSINGS.ABSOLUTE:var c=e.load2Bytes(i,!0);n+=s.convertDecToHexString(c,4),r&&(n+="("+s.convertDecToHexString(e.load(c,!0),2)+")");break;case this.ADDRESSINGS.INDEXED_ABSOLUTE_X:c=e.load2Bytes(i,!0);n+=s.convertDecToHexString(c,4)+",X ",r&&(c+=this.x.load(),c&=65535,n+="("+s.convertDecToHexString(e.load(c,!0),2)+")");break;case this.ADDRESSINGS.INDEXED_ABSOLUTE_Y:c=e.load2Bytes(i,!0);n+=s.convertDecToHexString(c,4)+",Y ",r&&(c+=this.y.load(),c&=65535,n+="("+s.convertDecToHexString(e.load(c,!0),2)+")");break;case this.ADDRESSINGS.ZERO_PAGE:c=e.load(i,!0);n+=s.convertDecToHexString(c,2),r&&(n+="("+s.convertDecToHexString(e.load(c,!0),2)+")");break;case this.ADDRESSINGS.INDEXED_ZERO_PAGE_X:c=e.load(i,!0);n+=s.convertDecToHexString(c,2)+",X ",r&&(c+=this.x.load(),c&=255,n+="("+s.convertDecToHexString(e.load(c,!0),2)+")");break;case this.ADDRESSINGS.INDEXED_ZERO_PAGE_Y:c=e.load(i,!0);n+=s.convertDecToHexString(c,2)+",Y ",r&&(c+=this.y.load(),c&=255,n+="("+s.convertDecToHexString(e.load(c,!0),2)+")");break;case this.ADDRESSINGS.INDIRECT:c=e.load2Bytes(i,!0);if(n+=s.convertDecToHexString(c,4),r){var h=e.load2Bytes(c,!0);n+="(",n+=s.convertDecToHexString(h,4),n+="("+s.convertDecToHexString(e.load(h,!0),2)+")",n+=")"}break;case this.ADDRESSINGS.INDEXED_INDIRECT_X:c=e.load(i,!0);if(n+="("+s.convertDecToHexString(c,2)+",X) ",r){c+=this.x.load(),c&=65535;h=e.load2Bytes(c,!0);n+="(",n+=s.convertDecToHexString(h,4),n+="("+s.convertDecToHexString(e.load(h,!0),2)+")",n+=")"}break;case this.ADDRESSINGS.INDEXED_INDIRECT_Y:c=e.load(i,!0);if(n+="("+s.convertDecToHexString(c,2)+"),Y ",r){h=e.load2BytesFromZeropage(c,!0);h+=this.y.load(),h&=65535,n+="(",n+=s.convertDecToHexString(h,4),n+="("+s.convertDecToHexString(e.load(h,!0),2)+")",n+=")"}break;case this.ADDRESSINGS.ACCUMULATOR:r&&(n+="A("+s.convertDecToHexString(this.a.load(),2)+")");break;default:throw new Error("Cpu: Unkown addressing mode.")}return n}}),h.prototype=Object.assign(Object.create(r.prototype),{isCpuStatusRegister:!0,N_BIT:7,V_BIT:6,A_BIT:5,B_BIT:4,D_BIT:3,I_BIT:2,Z_BIT:1,C_BIT:0,isN:function(){return this.isBitSet(this.N_BIT)},setN:function(){this.setBit(this.N_BIT)},clearN:function(){this.clearBit(this.N_BIT)},isV:function(){return this.isBitSet(this.V_BIT)},setV:function(){this.setBit(this.V_BIT)},clearV:function(){this.clearBit(this.V_BIT)},isA:function(){return this.IsBitSet(this.A_BIT)},setA:function(){this.setBit(this.A_BIT)},clearA:function(){this.clearBit(this.A_BIT)},isB:function(){return this.isBitSet(this.B_BIT)},setB:function(){this.setBit(this.B_BIT)},clearB:function(){this.clearBit(this.B_BIT)},isD:function(){return this.isBitSet(this.D_BIT)},setD:function(){this.setBit(this.D_BIT)},clearD:function(){this.clearBit(this.D_BIT)},isI:function(){return this.isBitSet(this.I_BIT)},setI:function(){this.setBit(this.I_BIT)},clearI:function(){this.clearBit(this.I_BIT)},isZ:function(){return this.isBitSet(this.Z_BIT)},setZ:function(){this.setBit(this.Z_BIT)},clearZ:function(){this.clearBit(this.Z_BIT)},isC:function(){return this.isBitSet(this.C_BIT)},setC:function(){this.setBit(this.C_BIT)},clearC:function(){this.clearBit(this.C_BIT)},dump:function(){var t="";return t+=r.prototype.dump.call(this),t+="(",t+=this.isN()?"N":"-",t+=this.isV()?"V":"-",t+=this.isB()?"B":"-",t+=this.isD()?"D":"-",t+=this.isI()?"I":"-",t+=this.isZ()?"Z":"-",t+=this.isC()?"C":"-",t+=")"}}),Object.assign(S.prototype,{isPpu:!0,PALETTES:[4285887861,4287568679,4289396736,4288610375,4285989007,4279435435,4278190247,4278193023,4278202179,4278208256,4278210816,4279713536,4284432155,4278190080,4278190080,4278190080,4290559164,4293882624,4293868323,4294115459,4290707647,4284154087,4278201307,4279193547,4278219659,4278228736,4278233856,4282094336,4287333120,4278190080,4278190080,4278190080,4294967295,4294950719,4294940511,4294806439,4294933495,4290213887,4284708863,4282096639,4282367987,4279489411,4283162447,4288215128,4292602624,4278190080,4278190080,4278190080,4294967295,4294961067,4294956999,4294953943,4294952959,4292593663,4289970175,4289453055,4288931839,4288937955,4290769835,4291821491,4294180767,4278190080,4278190080,4278190080],setCpu:function(t){this.cpu=t},setRom:function(t){this.rom=t},setDisplay:function(t){this.display=t},bootup:function(){this.ppustatus.store(128)},reset:function(){},runCycle:function(){this.renderPixel(),this.shiftRegisters(),this.fetch(),this.evaluateSprites(),this.updateFlags(),this.countUpScrollCounters(),this.countUpCycle()},loadRegister:function(t){switch(t){case 8194:var e=this.ppustatus.load();return this.ppustatus.clearVBlank(),this.registerFirstStore=!0,e;case 8196:return this.oamRam.load(this.oamaddr.load());case 8199:return(16383&this.currentVRamAddress)>=0&&(16383&this.currentVRamAddress)<16128?(e=this.vRamReadBuffer,this.vRamReadBuffer=this.load(this.currentVRamAddress)):(e=this.load(this.currentVRamAddress),this.vRamReadBuffer=e),this.incrementVRamAddress(),e}return 0},storeRegister:function(t,e){switch(t){case 8192:this.ppuctrl.store(e),this.temporalVRamAddress&=-3073,this.temporalVRamAddress|=(3&e)<<10;break;case 8193:this.ppumask.store(e);break;case 8195:this.oamaddr.store(e);break;case 8196:this.oamdata.store(e),this.oamRam.store(this.oamaddr.load(),e),this.oamaddr.increment();break;case 8197:this.ppuscroll.store(e),!0===this.registerFirstStore?(this.fineXScroll=7&e,this.temporalVRamAddress&=-32,this.temporalVRamAddress|=e>>3&31):(this.temporalVRamAddress&=-29665,this.temporalVRamAddress|=(248&e)<<2,this.temporalVRamAddress|=(7&e)<<12),this.registerFirstStore=!this.registerFirstStore;break;case 8198:!0===this.registerFirstStore?(this.temporalVRamAddress&=-32513,this.temporalVRamAddress|=(63&e)<<8):(this.ppuaddr.store(e),this.temporalVRamAddress&=-256,this.temporalVRamAddress|=255&e,this.currentVRamAddress=this.temporalVRamAddress),this.registerFirstStore=!this.registerFirstStore;break;case 8199:this.ppudata.store(e),this.store(this.currentVRamAddress,e),this.incrementVRamAddress();break;case 16404:this.oamdma.store(e);for(var i=256*e,s=this.oamaddr.load();s<256;s++)this.oamRam.store(s,this.cpu.load(i+s));this.cpu.stallCycle+=514}},load:function(t){return(t&=16383)<8192&&!0===this.rom.hasChrRom()?this.rom.load(t):t>=8192&&t<16128?this.vRam.load(this.getNameTableAddressWithMirroring(12287&t)):(t>=16128&&t<16384&&(t&=16159),16144===t&&(t=16128),16148===t&&(t=16132),16152===t&&(t=16136),16156===t&&(t=16140),this.vRam.load(t))},store:function(t,e){if((t&=16383)<8192&&!0===this.rom.hasChrRom())this.rom.store(t,e);else{if(!(t>=8192&&t<16128))return t>=16128&&t<16384&&(t&=16159),16144===t&&(t=16128),16148===t&&(t=16132),16152===t&&(t=16136),16156===t&&(t=16140),this.vRam.store(t,e);this.vRam.store(this.getNameTableAddressWithMirroring(12287&t),e)}},getNameTableAddressWithMirroring:function(t){t&=12287;var e=0;switch(this.rom.getMirroringType()){case this.rom.MIRRORINGS.SINGLE_SCREEN:e=8192;break;case this.rom.MIRRORINGS.HORIZONTAL:e=t>=8192&&t<9216||t>=9216&&t<10240?8192:9216;break;case this.rom.MIRRORINGS.VERTICAL:e=t>=8192&&t<9216?8192:t>=9216&&t<10240?9216:t>=10240&&t<11264?8192:9216;break;case this.rom.MIRRORINGS.FOUR_SCREEN:e=t>=8192&&t<9216?8192:t>=9216&&t<10240?9216:t>=10240&&t<11264?10240:11264}return e|1023&t},renderPixel:function(){if(!(this.cycle>=257||this.scanLine>=240||0===this.cycle)){var t=this.cycle-1,e=this.scanLine,i=this.ppumask.isBackgroundVisible(),s=this.ppumask.isSpritesVisible(),n=this.getBackgroundPixel(),r=this.spritePixels[t],o=this.spriteIds[t],c=this.spritePriorities[t],a=this.PALETTES[this.load(16128)];!0===i&&!0===s?a=-1===r?n:n===a||0===c?r:n:!0===i&&!1===s?a=n:!1===i&&!0===s&&-1!==r&&(a=r),!0===this.ppumask.emphasisRed()&&(a|=16711680),!0===this.ppumask.emphasisGreen()&&(a|=65280),!0===this.ppumask.emphasisBlue()&&(a|=255),!0===i&&!0===s&&0===o&&0!==r&&0!==n&&this.ppustatus.setZeroHit(),this.display.renderPixel(t,e,a)}},getBackgroundPixel:function(){var t=15-this.fineXScroll,e=this.patternTableHighRegister.loadBit(t)<<1|this.patternTableLowRegister.loadBit(t),i=(this.attributeTableHighRegister.loadBit(t)<<1|this.attributeTableLowRegister.loadBit(t))<<2|e;return!0===this.ppumask.isGreyscale()&&(i&=48),this.PALETTES[this.load(16128+i)]},shiftRegisters:function(){this.scanLine>=240&&this.scanLine<=260||(this.cycle>=1&&this.cycle<=256||this.cycle>=329&&this.cycle<=336)&&(this.patternTableLowRegister.shift(0),this.patternTableHighRegister.shift(0),this.attributeTableLowRegister.shift(0),this.attributeTableHighRegister.shift(0))},fetch:function(){if(!(this.scanLine>=240&&this.scanLine<=260||0===this.cycle||this.cycle>=257&&this.cycle<=320||this.cycle>=337)){switch((this.cycle-1)%8){case 0:this.fetchNameTable();break;case 2:this.fetchAttributeTable();break;case 4:this.fetchPatternTableLow();break;case 6:this.fetchPatternTableHigh()}this.cycle%8==1&&(this.nameTableRegister.store(this.nameTableLatch),this.attributeTableLowRegister.storeLowerByte(this.attributeTableLowLatch),this.attributeTableHighRegister.storeLowerByte(this.attributeTableHighLatch),this.patternTableLowRegister.storeLowerByte(this.patternTableLowLatch),this.patternTableHighRegister.storeLowerByte(this.patternTableHighLatch))}},fetchNameTable:function(){this.nameTableLatch=this.load(8192|4095&this.currentVRamAddress)},fetchAttributeTable:function(){var t=this.currentVRamAddress,e=9152|3072&t|t>>4&56|t>>2&7,i=this.load(e)>>((((t>>5&31)%4>=2?1:0)<<1|((31&t)%4>=2?1:0))<<1)&3,s=i>>1,n=1&i;this.attributeTableHighLatch=1===s?255:0,this.attributeTableLowLatch=1===n?255:0},fetchPatternTableLow:function(){var t=this.currentVRamAddress>>12&7,e=4096*this.ppuctrl.getBackgroundPatternTableNum()+16*this.nameTableRegister.load()+t;this.patternTableLowLatch=this.load(e)},fetchPatternTableHigh:function(){var t=this.currentVRamAddress>>12&7,e=4096*this.ppuctrl.getBackgroundPatternTableNum()+16*this.nameTableRegister.load()+t;this.patternTableHighLatch=this.load(e+8)},updateFlags:function(){1===this.cycle&&(241===this.scanLine?(this.ppustatus.setVBlank(),this.display.updateScreen()):261===this.scanLine&&(this.ppustatus.clearVBlank(),this.ppustatus.clearZeroHit(),this.ppustatus.clearOverflow())),10===this.cycle&&241===this.scanLine&&!0===this.ppuctrl.enabledNmi()&&this.cpu.interrupt(this.cpu.INTERRUPTS.NMI)},countUpScrollCounters:function(){if((!1!==this.ppumask.isBackgroundVisible()||!1!==this.ppumask.isSpritesVisible())&&!(this.scanLine>=240&&this.scanLine<=260||(261===this.scanLine&&this.cycle>=280&&this.cycle<=304&&(this.currentVRamAddress&=-31713,this.currentVRamAddress|=31712&this.temporalVRamAddress),0===this.cycle||this.cycle>=258&&this.cycle<=320))){if(this.cycle%8==0)31==(31&(t=this.currentVRamAddress))?(t&=-32,t^=1024):t++,this.currentVRamAddress=t;if(256===this.cycle){var t;if(28672!=(28672&(t=this.currentVRamAddress)))t+=4096;else{var e=(992&(t&=-28673))>>5;29===e?(e=0,t^=2048):31===e?e=0:e++,t=-993&t|e<<5}this.currentVRamAddress=t}257===this.cycle&&(this.currentVRamAddress&=-1056,this.currentVRamAddress|=1055&this.temporalVRamAddress)}},countUpCycle:function(){this.cycle++,this.cycle>340&&(this.cycle=0,this.scanLine++,this.scanLine>261&&(this.scanLine=0,this.frame++))},incrementVRamAddress:function(){this.currentVRamAddress+=this.ppuctrl.isIncrementAddressSet()?32:1,this.currentVRamAddress&=32767,this.ppuaddr.store(255&this.currentVRamAddress)},evaluateSprites:function(){if(!(this.scanLine>=240))if(0===this.cycle){this.processSpritePixels();for(var t=0,e=this.oamRam2.getCapacity();t<e;t++)this.oamRam2.store(t,255)}else if(65===this.cycle){var i=this.ppuctrl.isSpriteSize16()?16:8,s=0;for(t=0,e=this.spritesManager.getNum();t<e;t++){var n=this.spritesManager.get(t);if(!0===n.on(this.scanLine,i)){if(!(s<8)){this.ppustatus.setOverflow();break}this.spritesManager2.copy(s++,n)}}}},processSpritePixels:function(){for(var t=this.scanLine-1,e=0,i=this.spritePixels.length;e<i;e++)this.spritePixels[e]=-1,this.spriteIds[e]=-1,this.spritePriorities[e]=-1;var s=!0===this.ppuctrl.isSpriteSize16()?16:8;for(e=0,i=this.spritesManager2.getNum();e<i;e++){var n=this.spritesManager2.get(e);if(n.isEmpty())break;for(var r=n.getXPosition(),o=t-n.getYPosition(),c=n.doFlipVertically()?s-o-1:o,a=n.doFlipHorizontally(),h=8===s?n.getTileIndex():n.getTileIndexForSize16(),S=n.getPalletNum(),u=0;u<8;u++){var I=a?7-u:u,d=r+u;if(d>=256)break;var l=this.getPatternTableElement(h,I,c,s);if(0!==l){var T=S<<2|l;-1===this.spritePixels[d]&&(this.spritePixels[d]=this.PALETTES[this.load(16144+T)],this.spriteIds[d]=n.getId(),this.spritePriorities[d]=n.getPriority())}}}},getPatternTableElement:function(t,e,i,s){var n,r,o=e%8;if(8===s){var c=i%8,a=1===this.ppuctrl.getSpritesPatternTableNum()?4096:0;n=this.load(a+16*t+c),r=this.load(a+16*t+8+c)}else{c=i%8;c+=16*(i>>3),n=this.load(t+c),r=this.load(t+c+8)}return n>>7-o&1|(r>>7-o&1)<<1},dump:function(){var t="";return t+="PPU Ctrl: "+this.ppuctrl.dump()+"\n",t+="PPU Mask: "+this.ppumask.dump()+"\n",t+="PPU Status: "+this.ppustatus.dump()+"\n",t+="OAM Address: "+this.oamaddr.dump()+"\n",t+="OAM Data: "+this.oamdata.dump()+"\n",t+="PPU Scroll: "+this.ppuscroll.dump()+"\n",t+="PPU Addr: "+this.ppuaddr.dump()+"\n",t+="PPU Data: "+this.ppudata.dump()+"\n",t+="OAM DMA: "+this.oamdma.dump()+"\n",t+="\n"},dumpVRAM:function(){for(var t="",e=!1,i=0;i<65536;i++){if(i%16==0){if(e){for(var n=!1;this._checkNext16BytesIsZero(i+16);)i+=16,n=!0;n&&(t+="...\n")}t+=s.convertDecToHexString(i-0,4)+" ",e=!0}var r=this.load(i);t+=s.convertDecToHexString(r,2,!0)+" ",0!=r&&(e=!1),i%16==15&&(t+="\n")}return t},_checkNext16BytesIsZero:function(t){if(t+16>=65536)return!1;for(var e=0,i=t;i<t+16;i++)e+=this.load(i);return 0==e},dumpSPRRAM:function(){return this.oamRam.dump()}}),u.prototype=Object.assign(Object.create(r.prototype),{isPpuControlRegister:!0,NMI_VBLANK_BIT:7,MASTER_SLAVE_BIT:6,SPRITES_SIZE_BIT:5,BACKGROUND_PATTERN_TABLE_BIT:4,SPRITES_PATTERN_TABLE_BIT:3,INCREMENT_ADDRESS_BIT:2,NAME_TABLE_ADDRESS_BIT:0,NAME_TABLE_ADDRESS_BITS_WIDTH:2,isIncrementAddressSet:function(){return this.isBitSet(this.INCREMENT_ADDRESS_BIT)},enabledNmi:function(){return this.isBitSet(this.NMI_VBLANK_BIT)},isSpriteSize16:function(){return this.isBitSet(this.SPRITES_SIZE_BIT)},getBackgroundPatternTableNum:function(){return this.loadBit(this.BACKGROUND_PATTERN_TABLE_BIT)},getSpritesPatternTableNum:function(){return this.loadBit(this.SPRITES_PATTERN_TABLE_BIT)},getNameTableAddress:function(){return this.loadBits(this.NAME_TABLE_ADDRESS_BIT,this.NAME_TABLE_ADDRESS_BITS_WIDTH)}}),I.prototype=Object.assign(Object.create(r.prototype),{isPpuMaskRegister:!0,GREYSCALE_BIT:0,LEFTMOST_BACKGROUND_VISIBLE_BIT:1,LEFTMOST_SPRITES_VISIBLE_BIT:2,BACKGROUND_VISIBLE_BIT:3,SPRITES_VISIBLE_BIT:4,EMPHASIZE_RED_BIT:5,EMPHASIZE_GREEN_BIT:6,EMPHASIZE_BLUE_BIT:7,isGreyscale:function(){return this.isBitSet(this.GREYSCALE_BIT)},isLeftMostBackgroundVisible:function(){return this.isBitSet(this.LEFTMOST_BACKGROUND_VISIBLE_BIT)},isLeftMostSpritesVisible:function(){return this.isBitSet(this.LEFTMOST_SPRITES_VISIBLE_BIT)},isBackgroundVisible:function(){return this.isBitSet(this.BACKGROUND_VISIBLE_BIT)},isSpritesVisible:function(){return this.isBitSet(this.SPRITES_VISIBLE_BIT)},emphasisRed:function(){return this.isBitSet(this.EMPHASIZE_RED_BIT)},emphasisGreen:function(){return this.isBitSet(this.EMPHASIZE_GREEN_BIT)},emphasisBlue:function(){return this.isBitSet(this.EMPHASIZE_BLUE_BIT)}}),d.prototype=Object.assign(Object.create(r.prototype),{isPpuStatusRegister:!0,VBLANK_BIT:7,SPRITE_ZERO_HIT_BIT:6,SPRITE_OVERFLOW_BIT:5,setVBlank:function(){this.setBit(this.VBLANK_BIT)},clearVBlank:function(){this.clearBit(this.VBLANK_BIT)},setZeroHit:function(){this.setBit(this.SPRITE_ZERO_HIT_BIT)},clearZeroHit:function(){this.clearBit(this.SPRITE_ZERO_HIT_BIT)},setOverflow:function(){this.setBit(this.SPRITE_OVERFLOW_BIT)},clearOverflow:function(){this.clearBit(this.SPRITE_OVERFLOW_BIT)}}),Object.assign(l.prototype,{isSpritesManager:!0,init:function(t){for(var e=0,i=t.getCapacity()/4;e<i;e++)this.sprites.push(new T(e,e,t))},getNum:function(){return this.sprites.length},get:function(t){return this.sprites[t]},copy:function(t,e){this.sprites[t].copy(e)}}),Object.assign(T.prototype,{isSprite:!0,getId:function(){return this.id},setId:function(t){this.id=t},getByte0:function(){return this.memory.load(4*this.index+0)},getByte1:function(){return this.memory.load(4*this.index+1)},getByte2:function(){return this.memory.load(4*this.index+2)},getByte3:function(){return this.memory.load(4*this.index+3)},setByte0:function(t){this.memory.store(4*this.index+0,t)},setByte1:function(t){this.memory.store(4*this.index+1,t)},setByte2:function(t){this.memory.store(4*this.index+2,t)},setByte3:function(t){this.memory.store(4*this.index+3,t)},copy:function(t){this.setId(t.getId()),this.setByte0(t.getByte0()),this.setByte1(t.getByte1()),this.setByte2(t.getByte2()),this.setByte3(t.getByte3())},isEmpty:function(){return 255===this.getByte0()&&255===this.getByte1()&&255===this.getByte2()&&255===this.getByte3()},isVisible:function(){return this.getByte0()<239},getYPosition:function(){return this.getByte0()-1},getXPosition:function(){return this.getByte3()},getTileIndex:function(){return this.getByte1()},getTileIndexForSize16:function(){return 4096*(1&this.getByte1())+32*(this.getByte1()>>1)},getPalletNum:function(){return 3&this.getByte2()},getPriority:function(){return this.getByte2()>>5&1},doFlipHorizontally:function(){return!!(this.getByte2()>>6&1)},doFlipVertically:function(){return!!(this.getByte2()>>7&1)},on:function(t,e){return t>=this.getYPosition()&&t<this.getYPosition()+e}}),Object.assign(N.prototype,{isApu:!0,setCpu:function(t){this.cpu=t},setAudio:function(t){this.audio=t,this.samplePeriod=1789773/this.audio.getSampleRate()|0},bootup:function(){this.status.store(0)},reset:function(){},runCycle:function(){this.cycle++,this.cycle%this.samplePeriod==0&&this.sample(),this.cycle%2==0&&(this.pulse1.driveTimer(),this.pulse2.driveTimer(),this.noise.driveTimer(),this.dmc.driveTimer()),this.triangle.driveTimer(),this.cycle%7457==0&&(!0===this.frame.isFiveStepMode()?(this.step<4&&(this.pulse1.driveEnvelope(),this.pulse2.driveEnvelope(),this.triangle.driveLinear(),this.noise.driveEnvelope()),0!==this.step&&2!==this.step||(this.pulse1.driveLength(),this.pulse1.driveSweep(),this.pulse2.driveLength(),this.pulse2.driveSweep(),this.triangle.driveLength(),this.noise.driveLength()),this.step=(this.step+1)%5):(this.pulse1.driveEnvelope(),this.pulse2.driveEnvelope(),this.triangle.driveLinear(),this.noise.driveEnvelope(),1!==this.step&&3!==this.step||(this.pulse1.driveLength(),this.pulse1.driveSweep(),this.pulse2.driveLength(),this.pulse2.driveSweep(),this.triangle.driveLength(),this.noise.driveLength()),3===this.step&&!1===this.frame.disabledIrq()&&(this.frameIrqActive=!0),!0===this.frameIrqActive&&!1===this.frame.disabledIrq()&&this.cpu.interrupt(this.cpu.INTERRUPTS.IRQ),this.step=(this.step+1)%4),!0===this.dmcIrqActive&&this.cpu.interrupt(this.cpu.INTERRUPTS.IRQ))},loadRegister:function(t){switch(t){case 16405:var e=0;return e|=(!0===this.dmcIrqActive?1:0)<<7,e|=(!0===this.frameIrqActive&&!1===this.frame.disabledIrq()?1:0)<<6,e|=(this.dmc.remainingBytes>0?1:0)<<4,e|=(this.noise.lengthCounter>0?1:0)<<3,e|=(this.triangle.lengthCounter>0?1:0)<<2,e|=(this.pulse2.lengthCounter>0?1:0)<<1,e|=(this.pulse1.lengthCounter>0?1:0)<<0,this.frameIrqActive=!1,e}return 0},storeRegister:function(t,e){switch(t){case 16384:case 16385:case 16386:case 16387:this.pulse1.storeRegister(t,e);break;case 16388:case 16389:case 16390:case 16391:this.pulse2.storeRegister(t,e);break;case 16392:case 16393:case 16394:case 16395:this.triangle.storeRegister(t,e);break;case 16396:case 16397:case 16398:case 16399:this.noise.storeRegister(t,e);break;case 16400:case 16401:case 16402:case 16403:this.dmc.storeRegister(t,e);break;case 16405:this.status.store(e),this.dmc.setEnable(16==(16&e)),this.noise.setEnable(8==(8&e)),this.triangle.setEnable(4==(4&e)),this.pulse2.setEnable(2==(2&e)),this.pulse1.setEnable(1==(1&e)),this.dmcIrqActive=!1;break;case 16407:this.frame.store(e),!0===this.frame.disabledIrq()&&(this.frameIrqActive=!1)}},sample:function(){var t=this.pulse1.output(),e=this.pulse2.output(),i=this.triangle.output(),s=this.noise.output(),n=this.dmc.output(),r=0,o=0;0===t&&0===e||(r=95.88/(8128/(t+e)+100)),0===i&&0===s&&0===n||(o=159.79/(1/(i/8227+s/12241+n/22638)+100)),this.audio.push(r+o)},dump:function(){}}),R.LENGTH_TABLE=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],Object.assign(E.prototype,{isApuPulse:!0,LENGTH_TABLE:R.LENGTH_TABLE,DUTY_TABLE:[[0,1,0,0,0,0,0,0],[0,1,1,0,0,0,0,0],[0,1,1,1,1,0,0,0],[1,0,0,1,1,1,1,1]],storeRegister:function(t,e){switch(t){case 16384:case 16388:this.register0.store(e);break;case 16385:case 16389:this.register1.store(e),this.sweepReloadFlag=!0;break;case 16386:case 16390:this.register2.store(e),this.timerPeriod=this.getTimer();break;case 16387:case 16391:this.register3.store(e),!0===this.enabled&&(this.lengthCounter=this.LENGTH_TABLE[this.getLengthCounterIndex()]),this.timerPeriod=this.getTimer(),this.timerSequence=0,this.envelopeStartFlag=!0}},setEnable:function(t){this.enabled=t,!1===t&&(this.lengthCounter=0)},getDuty:function(){return this.register0.loadBits(6,2)},enabledEnvelopeLoop:function(){return this.register0.isBitSet(5)},disabledEnvelope:function(){return this.register0.isBitSet(4)},getEnvelopePeriod:function(){return this.register0.loadBits(0,4)},enabledSweep:function(){return this.register1.isBitSet(7)},getSweepPeriod:function(){return this.register1.loadBits(4,3)},negatedSweep:function(){return this.register1.isBitSet(3)},getSweepShiftAmount:function(){return this.register1.loadBits(0,3)},getTimerLow:function(){return this.register2.load()},getTimerHigh:function(){return this.register3.loadBits(0,3)},getTimer:function(){return this.getTimerHigh()<<8|this.getTimerLow()},getLengthCounterIndex:function(){return this.register3.loadBits(3,5)},driveTimer:function(){this.timerCounter>0?this.timerCounter--:(this.timerCounter=this.timerPeriod,this.timerSequence++,8===this.timerSequence&&(this.timerSequence=0))},driveLength:function(){!1===this.disabledEnvelope()&&this.lengthCounter>0&&this.lengthCounter--},driveEnvelope:function(){if(!0===this.envelopeStartFlag)return this.envelopeCounter=this.getEnvelopePeriod(),this.envelopeDecayLevelCounter=15,void(this.envelopeStartFlag=!1);this.envelopeCounter>0?this.envelopeCounter--:(this.envelopeCounter=this.getEnvelopePeriod(),this.envelopeDecayLevelCounter>0?this.envelopeDecayLevelCounter--:0===this.envelopeDecayLevelCounter&&!0===this.enabledEnvelopeLoop()&&(this.envelopeDecayLevelCounter=15))},driveSweep:function(){if(0===this.sweepCounter&&!0===this.enabledSweep()&&0!==this.getSweepShiftAmount()&&this.timerPeriod>=8&&this.timerPeriod<=2047){var t=this.timerPeriod>>this.getSweepShiftAmount();!0===this.negatedSweep()&&(t=-t,!0===this.isChannel1&&t--),this.timerPeriod+=t}!0===this.sweepReloadFlag||0===this.sweepCounter?(this.sweepReloadFlag=!1,this.sweepCounter=this.getSweepPeriod()):this.sweepCounter--},output:function(){return 0===this.lengthCounter||this.timerPeriod<8||this.timerPeriod>2047||0===this.DUTY_TABLE[this.getDuty()][this.timerSequence]?0:15&(!0===this.disabledEnvelope()?this.getEnvelopePeriod():this.envelopeDecayLevelCounter)}}),Object.assign(p.prototype,{isApuTriangle:!0,LENGTH_TABLE:R.LENGTH_TABLE,SEQUENCE_TABLE:[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],storeRegister:function(t,e){switch(t){case 16392:this.register0.store(e);break;case 16393:this.register1.store(e);break;case 16394:this.register2.store(e);break;case 16395:this.register3.store(e),!0===this.enabled&&(this.lengthCounter=this.LENGTH_TABLE[this.getLengthCounterIndex()]),this.timerSequence=0,this.linearReloadFlag=!0}},setEnable:function(t){this.enabled=t,!1===t&&(this.lengthCounter=0)},getLinearCounter:function(){return this.register0.loadBits(0,7)},disabledLengthCounter:function(){return this.register0.isBitSet(7)},getLengthCounterIndex:function(){return this.register3.loadBits(3,5)},getTimerLow:function(){return this.register2.load()},getTimerHigh:function(){return this.register3.loadBits(0,3)},getTimer:function(){return this.getTimerHigh()<<8|this.getTimerLow()},driveTimer:function(){this.timerCounter>0?this.timerCounter--:(this.timerCounter=this.getTimer(),this.lengthCounter>0&&this.linearCounter>0&&(this.timerSequence++,32===this.timerSequence&&(this.timerSequence=0)))},driveLinear:function(){!0===this.linearReloadFlag?this.linearCounter=this.getLinearCounter():this.linearCounter>0&&this.linearCounter--,!1===this.disabledLengthCounter()&&(this.linearReloadFlag=!1)},driveLength:function(){!1===this.disabledLengthCounter()&&this.lengthCounter>0&&this.lengthCounter--},output:function(){return!1===this.enabled||0===this.lengthCounter||0===this.linearCounter||this.getTimer()<2?0:15&this.SEQUENCE_TABLE[this.timerSequence]}}),Object.assign(m.prototype,{isApuNoise:!0,LENGTH_TABLE:R.LENGTH_TABLE,TIMER_TABLE:[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],storeRegister:function(t,e){switch(t){case 16396:this.register0.store(e);break;case 16397:this.register1.store(e);break;case 16398:this.register2.store(e),this.timerPeriod=this.TIMER_TABLE[this.getTimerIndex()];break;case 16399:this.register3.store(e),!0===this.enabled&&(this.lengthCounter=this.LENGTH_TABLE[this.getLengthCounterIndex()]),this.envelopeStartFlag=!0}},setEnable:function(t){this.enabled=t,!1===t&&(this.lengthCounter=0)},disabledLengthCounter:function(){return this.register0.isBitSet(5)},disabledEnvelope:function(){return this.register0.isBitSet(4)},getEnvelopePeriod:function(){return this.register0.loadBits(0,4)},isRandom:function(){return this.register2.isBitSet(7)},getTimerIndex:function(){return this.register2.loadBits(0,4)},getLengthCounterIndex:function(){return this.register3.loadBits(3,5)},driveTimer:function(){if(this.timerCounter>0)this.timerCounter--;else{this.timerCounter=this.timerPeriod;var t=1&this.shiftRegister^this.shiftRegister>>(!0===this.isRandom()?6:1)&1;this.shiftRegister=t<<14|this.shiftRegister>>1}},driveEnvelope:function(){if(!0===this.envelopeStartFlag)return this.envelopeCounter=this.getEnvelopePeriod(),this.envelopeDecayLevelCounter=15,void(this.envelopeStartFlag=!1);this.envelopeCounter>0?this.envelopeCounter--:(this.envelopeCounter=this.getEnvelopePeriod(),this.envelopeDecayLevelCounter>0?this.envelopeDecayLevelCounter--:0===this.envelopeDecayLevelCounter&&!0===this.disabledLengthCounter()&&(this.envelopeDecayLevelCounter=15))},driveLength:function(){!1===this.disabledLengthCounter()&&this.lengthCounter>0&&this.lengthCounter--},output:function(){return 0===this.lengthCounter||1==(1&this.shiftRegister)?0:15&(!0===this.disabledEnvelope()?this.getEnvelopePeriod():this.envelopeDecayLevelCounter)}}),Object.assign(D.prototype,{isApuDmc:!0,TIMER_TABLE:[428,380,340,320,286,254,226,214,190,160,142,128,106,84,72,54],storeRegister:function(t,e){switch(t){case 16400:this.register0.store(e),this.timerPeriod=this.TIMER_TABLE[this.getTimerIndex()]>>1;break;case 16401:this.register1.store(e),this.start();break;case 16402:this.register2.store(e),this.start();break;case 16403:this.register3.store(e),this.start()}},setEnable:function(t){this.enabled=t,!0===t?0===this.remainingBytesCounter&&this.start():this.remainingBytesCounter=0},start:function(){this.deltaCounter=this.getDeltaCounter(),this.addressCounter=64*this.getSampleAddress()+49152,this.remainingBytesCounter=16*this.getSampleLength()+1},enabledIrq:function(){return this.register0.isBitSet(7)},isLoop:function(){return this.register0.isBitSet(6)},getTimerIndex:function(){return this.register0.loadBits(0,4)},getDeltaCounter:function(){return this.register1.loadBits(0,7)},getSampleAddress:function(){return this.register2.load()},getSampleLength:function(){return this.register3.load()},driveTimer:function(){this.timerCounter>0?this.timerCounter--:(this.timerCounter=this.timerPeriod,this.remainingBytesCounter>0&&!0===this.sampleBufferIsEmpty&&(this.sampleBuffer=this.apu.cpu.load(this.sampleAddress++),this.sampleBufferIsEmpty=!1,this.sampleAddress>65535&&(this.sampleAddress=32768),this.remainingBytesCounter--,0===this.remainingBytesCounter&&(!0===this.isLoop()?this.start():!0===this.enabledIrq()&&(this.apu.dmcIrqActive=!0)),this.apu.cpu.stallCycle+=4),0===this.remainingBitsCounter&&(this.remainingBitsCounter=8,!0===this.sampleBufferIsEmpty?this.silenceFlag=!0:(this.silenceFlag=!1,this.sampleBufferIsEmpty=!0,this.shiftRegister=this.sampleBuffer,this.sampleBuffer=0)),!1===this.silenceFlag&&(0==(1&this.shiftRegister)?this.deltaCounter>1&&(this.deltaCounter-=2):this.deltaCounter<126&&(this.deltaCounter+=2)),this.shiftRegister=this.shiftRegister>>1,this.remainingBitsCounter--)},output:function(){return!0===this.silenceFlag?0:127&this.deltaCounter}}),A.prototype=Object.assign(Object.create(r.prototype),{isApuStatusRegister:!0,ENABLE_DMC_BIT:4,ENABLE_NOISE_BIT:3,ENABLE_TRIANGLE_BIT:2,ENABLE_PULSE2_BIT:1,ENABLE_PULSE1_BIT:0}),C.prototype=Object.assign(Object.create(r.prototype),{isApuFrameRegister:!0,MODE_BIT:7,IRQ_BIT:6,isFiveStepMode:function(){return this.isBitSet(this.MODE_BIT)},disabledIrq:function(){return this.isBitSet(this.IRQ_BIT)}}),g.BUTTONS={A:0,B:1,SELECT:2,START:3,UP:4,DOWN:5,LEFT:6,RIGHT:7},Object.assign(g.prototype,{isJoypad:!0,getButtonsNum:function(){var t=0;for(var e in g.BUTTONS)t++;return t},pressButton:function(t){this.buttons[t]=!0},releaseButton:function(t){this.buttons[t]=!1},loadRegister:function(){var t=1===this.latch?0:this.currentButton++;return t>=this.buttonNum||this.buttons[t]?1:0},storeRegister:function(t){this.register.store(t),1===(t&=1)&&(this.currentButton=0),this.latch=t},dump:function(){}}),Object.assign(O.prototype,{isNes:!0,STATES:{POWER_OFF:0,RUN:1,STOP:2},KEY_TO_PAD_BUTTONS:{13:g.BUTTONS.START,32:g.BUTTONS.SELECT,37:g.BUTTONS.LEFT,38:g.BUTTONS.UP,39:g.BUTTONS.RIGHT,40:g.BUTTONS.DOWN,88:g.BUTTONS.A,90:g.BUTTONS.B},addEventListener:function(t,e){switch(t){case"fps":this.onFpsUpdates.push(e);break;default:throw new Error("Nes.addEventListener: unknown type "+t)}},invokeFpsUpdateListeners:function(t){for(var e=0,i=this.onFpsUpdates.length;e<i;e++)this.onFpsUpdates[e](t)},setRom:function(t){this.rom=t,this.cpu.setRom(t),this.ppu.setRom(t)},setDisplay:function(t){this.ppu.setDisplay(t)},setAudio:function(t){this.apu.setAudio(t),this.audioEnabled=!0},bootup:function(){this.cpu.bootup(),this.ppu.bootup(),this.apu.bootup(),this.state=this.STATES.RUN},reset:function(){this.cpu.reset(),this.ppu.reset(),this.apu.reset()},stop:function(){this.state=this.STATES.STOP},resume:function(){this.state=this.STATES.RUN,this.run()},run:function(){this.measureFps();for(var t=0;t<29780;t++)this.runCycle();this.state===this.STATES.RUN&&requestAnimationFrame(this.runFunc)},runCycle:function(){this.cpu.runCycle(),this.ppu.runCycle(),this.ppu.runCycle(),this.ppu.runCycle(),!0===this.audioEnabled&&this.apu.runCycle()},runStep:function(){if(this.state===this.STATES.STOP)do{this.runCycle()}while(this.cpu.isStall())},handleKeyDown:function(t){void 0!==this.KEY_TO_PAD_BUTTONS[t.keyCode]&&this.pad1.pressButton(this.KEY_TO_PAD_BUTTONS[t.keyCode]),t.preventDefault()},handleKeyUp:function(t){void 0!==this.KEY_TO_PAD_BUTTONS[t.keyCode]&&this.pad1.releaseButton(this.KEY_TO_PAD_BUTTONS[t.keyCode]),t.preventDefault()},measureFps:(y=null,B=0,function(){if(60===B){var t=performance.now();null!==y&&this.invokeFpsUpdateListeners(6e4/(t-y)),y=t,B=0}B++}),dumpCpu:function(){return this.cpu.dump()},dumpRam:function(){return this.cpu.dumpRAM()},dumpRom:function(){var t="";return t+=this.rom.dumpHeader(),t+="\n",t+=this.rom.dump(),t+="\n",t+=this.cpu.disassembleROM(),t+="\n"},dumpPpu:function(){return this.ppu.dump()},dumpVRam:function(){return this.ppu.dumpVRAM()},dumpSprRam:function(){return this.ppu.dumpSPRRAM()}}),Object.assign(f.prototype,{isMapperFactory:!0,MAPPERS:{0:{name:"NROM",class:U},1:{name:"MMC1",class:L},2:{name:"UNROM",class:b},3:{name:"CNROM",class:P},76:{name:"Mapper76",class:v}},getMapperParam:function(t){if(void 0===this.MAPPERS[t])throw new Error("unsupport No."+t+" Mapper");return this.MAPPERS[t]},create:function(t,e){return new(this.getMapperParam(t).class)(e)},getName:function(t){return this.getMapperParam(t).name}}),Object.assign(_.prototype,{isMapper:!0,map:function(t){return t},mapForChrRom:function(t){return t},store:function(t,e){},getMirroringType:function(){return!0===this.rom.header.isHorizontalMirroring()?this.rom.MIRRORINGS.HORIZONTAL:this.rom.MIRRORINGS.VERTICAL}}),U.prototype=Object.assign(Object.create(_.prototype),{isNROMMapper:!0,map:function(t){return 1===this.prgBankNum&&t>=49152&&(t-=16384),t}}),L.prototype=Object.assign(Object.create(_.prototype),{isMMC1Mapper:!0,map:function(t){var e=0,i=16383&t,s=15&this.prgBankRegister.load();switch(this.controlRegister.loadBits(2,2)){case 0:case 1:i|=16384&t,e=14&s;break;case 2:e=t<49152?0:s;break;case 3:e=t>=49152?this.prgBankNum-1:s}return 16384*e+i+32768},mapForChrRom:function(t){var e,i=4095&t;return 0===this.controlRegister.loadBit(4)?(e=30&this.chrBank0Register.load(),i|=4096&t):e=31&(t<4096?this.chrBank0Register.load():this.chrBank1Register.load()),4096*e+i},store:function(t,e){if(128&e)this.registerWriteCount=0,this.latch.clear(),0==(24576&t)&&this.controlRegister.storeBits(2,2,3);else if(this.latch.store((1&e)<<4|this.latch.load()>>1),this.registerWriteCount++,this.registerWriteCount>=5){var i=this.latch.load();switch(24576&t){case 0:this.controlRegister.store(i);break;case 8192:this.chrBank0Register.store(i);break;case 16384:this.chrBank1Register.store(i);break;case 24576:this.prgBankRegister.store(i)}this.registerWriteCount=0,this.latch.clear()}},getMirroringType:function(){switch(this.controlRegister.loadBits(0,2)){case 0:case 1:return this.rom.MIRRORINGS.SINGLE_SCREEN;case 2:return this.rom.MIRRORINGS.VERTICAL;case 3:return this.rom.MIRRORINGS.HORIZONTAL}}}),b.prototype=Object.assign(Object.create(_.prototype),{isUNROMMapper:!0,map:function(t){return 16384*(t<49152?this.reg.load():this.prgBankNum-1)+(16383&t)+32768},store:function(t,e){this.reg.store(15&e)}}),P.prototype=Object.assign(Object.create(_.prototype),{isCNROMMapper:!0,mapForChrRom:function(t){return 8192*this.reg.load()+(8191&t)},store:function(t,e){this.reg.store(15&e)}}),Object.assign(Object.create(_.prototype),{isMMC3Mapper:!0,map:function(t){return t},mapForChrRom:function(t){return t},store:function(t,e){65535}}),v.prototype=Object.assign(Object.create(_.prototype),{isMapper76:!0,map:function(t){var e,i=8191&t;switch(57344&t){case 32768:e=this.prgReg0.load();break;case 40960:e=this.prgReg1.load();break;case 49152:e=2*this.prgBankNum-2;break;case 57344:e=2*this.prgBankNum-1}return 8192*e+i+32768},mapForChrRom:function(t){var e,i=2047&t;switch(6144&t){case 0:e=this.chrReg0.load();break;case 2048:e=this.chrReg1.load();break;case 4096:e=this.chrReg2.load();break;case 6144:e=this.chrReg3.load()}return 2048*e+i},store:function(t,e){switch(57345&t){case 32768:this.addrReg.store(7&e);break;case 32769:var i;switch(this.addrReg.load()){case 0:case 1:return;case 2:i=this.chrReg0;break;case 3:i=this.chrReg1;break;case 4:i=this.chrReg2;break;case 5:i=this.chrReg3;break;case 6:i=this.prgReg0;break;case 7:i=this.prgReg1}i.store(63&e)}}}),M.MIRRORINGS={SINGLE_SCREEN:0,HORIZONTAL:1,VERTICAL:2,FOUR_SCREEN:3},M.prototype=Object.assign(Object.create(c.prototype),{isRom:!0,MIRRORINGS:M.MIRRORINGS,load:function(t){if(t<8192){var e=16384*this.header.getPRGROMBanksNum()+this.getHeaderSize();return this.data[this.mapper.mapForChrRom(t)+e]}e=-32768+this.getHeaderSize();return this.data[this.mapper.map(t)+e]},store:function(t,e){this.mapper.store(t,e)},isNes:function(){return this.header.isNes()},getHeaderSize:function(){return this.header.getSize()},hasChrRom:function(){return this.header.hasChrRom()},getMirroringType:function(){return this.mapper.getMirroringType()},dumpHeader:function(){return this.header.dump()},_getStartDumpAddress:function(){return this.getHeaderSize()},_getEndDumpAddress:function(){return this.getCapacity()}}),Object.assign(G.prototype,{isRomHeader:!0,size:16,VALID_SIGNATURE:"NES",VALID_MAGIC_NUMBER:26,SIGNATURE_ADDRESS:0,SIGNATURE_SIZE:3,MAGIC_NUMBER_ADDRESS:3,MAGIC_NUMBER_SIZE:1,PRG_ROM_BANKS_NUM_ADDRESS:4,PRG_ROM_BANKS_NUM_SIZE:1,CHR_ROM_BANKS_NUM_ADDRESS:5,CHR_ROM_BANKS_NUM_SIZE:1,CONTROL_BYTE1_ADDRESS:6,CONTROL_BYTE1_SIZE:1,CONTROL_BYTE2_ADDRESS:7,CONTROL_BYTE2_SIZE:1,RAM_BANKS_NUM_ADDRESS:8,RAM_BANKS_NUM_SIZE:1,UNUSED_ADDRESS:9,UNUSED_SIZE:7,MIRRORING_TYPE_BIT:0,MIRRORING_TYPE_BITS_WIDTH:1,MIRRORING_TYPE_HORIZONTAL:0,MIRRORING_TYPE_VERTICAL:1,BATTERY_BACKED_RAM_BIT:1,BATTERY_BACKED_RAM_BITS_WIDTH:1,TRAINER_512BYTES_BIT:2,TRAINER_512BYTES_BITS_WIDTH:1,FOUR_SCREEN_MIRRORING_BIT:3,FOUR_SCREEN_MIRRORING_BITS_WIDTH:1,MAPPER_LOWER_BIT:4,MAPPER_LOWER_BITS_WIDTH:4,MAPPER_HIGHER_BIT:4,MAPPER_HIGHER_BITS_WIDTH:4,getSize:function(){return this.size},isNes:function(){return this.getSignature()===this.VALID_SIGNATURE&&this.getMagicNumber()===this.VALID_MAGIC_NUMBER},load:function(t){return this.rom.loadWithoutMapping(t)},getSignature:function(){for(var t="",e=0;e<this.SIGNATURE_SIZE;e++)t+=String.fromCharCode(this.load(this.SIGNATURE_ADDRESS+e));return t},getMagicNumber:function(){return this.load(this.MAGIC_NUMBER_ADDRESS)},getPRGROMBanksNum:function(){return this.load(this.PRG_ROM_BANKS_NUM_ADDRESS)},getCHRROMBanksNum:function(){return this.load(this.CHR_ROM_BANKS_NUM_ADDRESS)},hasChrRom:function(){return this.getCHRROMBanksNum()>0},getControlByte1:function(){return this.load(this.CONTROL_BYTE1_ADDRESS)},getControlByte2:function(){return this.load(this.CONTROL_BYTE2_ADDRESS)},getRAMBanksNum:function(){return this.load(this.RAM_BANKS_NUM_ADDRESS)},getUnusedField:function(){for(var t=0,e=0;e<this.UNUSED_SIZE;e++)t=t<<8|this.load(this.UNUSED_ADDRESS+e);return t},extractBits:function(t,e,i){return t>>e&(1<<i)-1},getMirroringType:function(){return this.extractBits(this.getControlByte1(),this.MIRRORING_TYPE_BIT,this.MIRRORING_TYPE_BITS_WIDTH)},getMirroringTypeAsStrings:function(){return this.getMirroringType()===this.MIRRORING_TYPE_HORIZONTAL?"horizontal":"vertical"},isHorizontalMirroring:function(){return this.getMirroringType()===this.MIRRORING_TYPE_HORIZONTAL},getBatteryBackedRAM:function(){return this.extractBits(this.getControlByte1(),this.BATTERY_BACKED_RAM_BIT,this.BATTERY_BACKED_RAM_BITS_WIDTH)},getTrainer512Bytes:function(){return this.extractBits(this.getControlByte1(),this.TRAINER_512BYTES_BIT,this.TRAINER_512BYTES_BITS_WIDTH)},getFourScreenMirroring:function(){return this.extractBits(this.getControlByte1(),this.FOUR_SCREEN_MIRRORING_BIT,this.FOUR_SCREEN_MIRRORING_BITS_WIDTH)},getMapperNum:function(){var t=this.extractBits(this.getControlByte1(),this.MAPPER_LOWER_BIT,this.MAPPER_LOWER_BITS_WIDTH);return this.extractBits(this.getControlByte2(),this.MAPPER_HIGHER_BIT,this.MAPPER_HIGHER_BITS_WIDTH)<<this.MAPPER_LOWER_BITS_WIDTH|t},dump:function(){var t="";t+="0x ";for(var e=0;e<this.getSize();e++)t+=s.convertDecToHexString(this.load(e),2,!0)+" ";return t+="\n\n",t+="Signature: "+this.getSignature()+"\n",t+="Magic Number: "+s.convertDecToHexString(this.getMagicNumber(),2)+"\n",t+="PRG-ROM banks num: "+s.convertDecToHexString(this.getPRGROMBanksNum(),2)+"\n",t+="CHR-ROM banks num: "+s.convertDecToHexString(this.getCHRROMBanksNum(),2)+"\n",t+="Control1: "+s.convertDecToHexString(this.getControlByte1(),2)+"\n",t+="Control2: "+s.convertDecToHexString(this.getControlByte2(),2)+"\n",t+="RAM banks num: "+s.convertDecToHexString(this.getRAMBanksNum(),2)+"\n",t+="Unused field: "+s.convertDecToHexString(this.getUnusedField(),14)+"\n",t+="\n",t+="In control bytes\n",t+="Mirroring type: "+s.convertDecToHexString(this.getMirroringType())+"("+this.getMirroringTypeAsStrings()+")\n",t+="Battery-backed RAM: "+s.convertDecToHexString(this.getBatteryBackedRAM())+"\n",t+="512-byte trainer: "+s.convertDecToHexString(this.getTrainer512Bytes())+"\n",t+="Four screen mirroring: "+s.convertDecToHexString(this.getFourScreenMirroring())+"\n",t+="Mapper number: "+s.convertDecToHexString(this.getMapperNum(),2)+"("+this.rom.mapperFactory.getName(this.getMapperNum())+")"}}),Object.assign(k.prototype,{isAudio:!0,getSampleRate:function(){return this.sampleRate},onAudioProcess:function(t){for(var e=t.outputBuffer.getChannelData(0),i=0,s=this.bufferLength;i<s;i++)e[i]=this.buffer[i];for(i=this.bufferIndex,s=this.bufferLength;i<s;i++)e[i]=0===this.bufferIndex?0:this.buffer[this.bufferIndex-1];this.bufferIndex=0},push:function(t){this.bufferIndex>=this.bufferLength||(this.buffer[this.bufferIndex++]=t)}}),Object.assign(V.prototype,{isDisplay:!0,renderPixel:function(t,e,i){var s=e*this.width+t;this.uint32[s]=i},updateScreen:function(){this.ctx.putImageData(this.data,0,0)}}),w.Nes=O,w.Rom=M,w.Audio=k,w.Display=V,void 0!==window&&(window.NesJs=w);let H=null;const x={87:g.BUTTONS.UP,83:g.BUTTONS.DOWN,65:g.BUTTONS.LEFT,68:g.BUTTONS.RIGHT,75:g.BUTTONS.A,74:g.BUTTONS.B,13:g.BUTTONS.START,32:g.BUTTONS.SELECT};function Z(t){var e;void 0!==x[t.keyCode]&&(e=x[t.keyCode],void 0!==X&&X.pad1.pressButton(e))}function Y(t){var e;void 0!==x[t.keyCode]&&(e=x[t.keyCode],void 0!==X&&X.pad1.releaseButton(e))}window.addEventListener("load",(function(){document.getElementById("file").addEventListener("change",async t=>{window.removeEventListener("keydown",Z),window.removeEventListener("keyup",Y),H=await t.target.files[0].arrayBuffer()}),document.getElementById("run").addEventListener("click",()=>{!async function(t){X=new NesJs.Nes,X.setRom(new NesJs.Rom(t)),X.setDisplay(new NesJs.Display(document.getElementById("nes-container"))),X.setAudio(new NesJs.Audio),window.addEventListener("keydown",Z),window.addEventListener("keyup",Y),X.bootup(),X.run()}(H)})}))}]);